{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NavBar - Panel</title>
    <!-- Referencia CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    {% include 'referencias.html' %}
</head>

<body>
    <nav class="navbar fixed-top navbar-expand-lg navbar-petcare">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'index' %}">
                <img src="{% static 'img/logo.png' %}" alt="logo" class="logo-navbar">
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="#nosotros">Nosotros</a></li>
                    <li class="nav-item"><a class="nav-link" href="#servicios">Servicios</a></li>
                    <li class="nav-item"><a class="nav-link" href="#cotizacion">Cotización</a></li>
                    <li class="nav-item"><a class="nav-link" href="#testimonios">Testimonios</a></li>
                    <li class="nav-item"><a class="nav-link" href="#preguntas_titulo">Preguntas frecuentes</a></li>
                    <li class="nav-item"><a class="nav-link" href="#contacto">Contacto</a></li>
                </ul>

                <!-- derecha -->
                <div class="ms-auto d-flex align-items-center gap-3">
                    <!-- Toggle tema -->
                    <label for="theme-switch" class="toggle" title="Cambiar tema">
                        <input type="checkbox" class="input" id="theme-switch" />
                        <div class="icon icon--moon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="icon icon--sun">
                            <!-- Sol icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"
                                fill="currentColor">
                                <path
                                    d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75z
                                        M7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0z
                                        M18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59z
                                        M21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75z
                                        M17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591z
                                        M12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18z
                                        M7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59z
                                        M6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12z
                                        M6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z">
                                </path>
                            </svg>
                        </div>
                    </label>
                </div>
            </div>
        </div>
    </nav>

    <!-- Subrayado en la seccion activa -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const nav = document.querySelector('.navbar-petcare');
            const navLinks = Array.from(document.querySelectorAll('.navbar-petcare .nav-link[href^="#"]'));

            // --- Medir altura real de la navbar y guardarla en la CSS var ---
            const setNavbarVar = () => {
                const h = nav ? nav.offsetHeight : 72;
                document.documentElement.style.setProperty('--navbar-h', h + 'px');
            };
            setNavbarVar();
            window.addEventListener('resize', setNavbarVar);

            // --- Mapeo de enlaces -> target real ---
            const targets = navLinks
                .map(a => {
                    try {
                        const id = a.getAttribute('href').trim();
                        if (!id || id === '#') return null;
                        const el = document.querySelector(id);
                        return el ? { link: a, el, id } : null;
                    } catch (_) { return null; }
                })
                .filter(Boolean);

            // --- Smooth scroll nativo (evita que el título quede tapado) ---
            navLinks.forEach(a => {
                a.addEventListener('click', (e) => {
                    const hash = a.getAttribute('href');
                    if (!hash || hash === '#') return;
                    const target = document.querySelector(hash);
                    if (!target) return;

                    e.preventDefault();
                    // Cerrar el collapse de Bootstrap en móvil si está abierto
                    const bsCollapseEl = document.querySelector('#navbarNav.show');
                    if (bsCollapseEl) {
                        const collapse = bootstrap.Collapse.getOrCreateInstance(bsCollapseEl);
                        collapse.hide();
                    }

                    // Hacer scroll suave; el offset lo maneja scroll-padding-top del CSS
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Actualizar la URL sin saltos bruscos
                    history.replaceState(null, '', hash);
                });
            });

            // --- Subrayado activo al hacer scroll (IntersectionObserver) ---
            let currentActive = null;
            const updateActive = (id) => {
                if (currentActive === id) return;
                currentActive = id;
                navLinks.forEach(l => l.classList.remove('active'));
                const match = navLinks.find(l => l.getAttribute('href') === `#${id}`);
                if (match) match.classList.add('active');
            };

            const makeObserver = () => {
                const h = nav ? nav.offsetHeight : 72;
                // margen superior negativo ≈ altura navbar + un respiro
                const topMargin = -(h + 12);
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) updateActive(entry.target.id);
                    });
                }, { rootMargin: `${topMargin}px 0px -60% 0px`, threshold: 0 });

                targets.forEach(t => observer.observe(t.el));
            };
            makeObserver();

            // --- Estado inicial (arranque en top o con hash) ---
            if (location.hash) {
                const el = document.querySelector(location.hash);
                if (el && el.id) updateActive(el.id);
            } else {
                // Si estás arriba del todo, marca "nosotros" por defecto si existe
                const def = targets.find(t => t.id === '#' || t.id === '');
                if (def && window.scrollY < 120) updateActive('');
            }

            // --- Si el hash cambia manualmente ---
            window.addEventListener('hashchange', () => {
                const el = document.querySelector(location.hash);
                if (el && el.id) updateActive(el.id);
            });
        });
    </script>

</body>

</html>